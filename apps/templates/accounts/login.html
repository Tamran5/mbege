{% extends 'layouts/base-fullscreen.html' %}

{% block title %} Masuk - MBG Monitor {% endblock title %}

{% block content %}

{% set active_tab = 'dapur' %}
{% if request.form.get('role') == 'government' %}
    {% set active_tab = 'gov' %}
{% endif %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
    /* --- Base Settings --- */
    body { font-family: 'Poppins', sans-serif; background: #f4f7f6; margin: 0; height: 100vh; }
    .login-wrapper { min-height: 100vh; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
    
    /* --- Card Style --- */
    .card-login { 
        background: #ffffff; width: 100%; max-width: 400px; padding: 40px 35px; 
        border-radius: 24px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); 
        text-align: center; position: relative; margin-bottom: 20px; 
    }

    .brand-icon { 
        width: 64px; height: 64px; background: linear-gradient(135deg, #e7f1ff 0%, #dbeafe 100%); 
        color: #0d6efd; border-radius: 20px; display: flex; align-items: center; justify-content: center; 
        margin: 0 auto 20px; font-size: 28px; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15); 
    }

    h3.welcome-title { font-weight: 700; color: #1a1a1a; margin-bottom: 5px; letter-spacing: -0.5px; }
    p.welcome-subtitle { color: #9ca3af; font-size: 0.9rem; margin-bottom: 25px; }
    
    /* --- Alert Section --- */
    .alert-container { margin-bottom: 25px; }
    .alert-custom {
        background-color: #FEF2F2;
        border: 1px solid #FEE2E2;
        color: #991B1B;
        padding: 12px 16px;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 10px;
        text-align: left;
        animation: fadeIn 0.4s ease-in-out;
    }
    .alert-custom:last-child { margin-bottom: 0; }
    .alert-custom i { font-size: 1.1rem; color: #EF4444; }
    .alert-custom a { color: #b91c1c; text-decoration: underline; font-weight: 700; }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* --- Role Switcher --- */
    .role-switch { display: flex; background: #f8f9fa; padding: 5px; border-radius: 14px; margin-bottom: 30px; border: 1px solid #f1f3f5; }
    .role-switch .nav-link { flex: 1; text-align: center; padding: 10px 0; border-radius: 10px; color: #6c757d; font-weight: 500; font-size: 0.85rem; border: none; transition: all 0.2s ease; margin: 0; cursor: pointer; }
    .role-switch .nav-link:hover { color: #343a40; }
    .role-switch .nav-link.active { background: #ffffff; color: #0d6efd; font-weight: 600; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

    /* --- Form Elements --- */
    .form-group { text-align: left; margin-bottom: 20px; }
    .form-label { font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 8px; display: block; }
    .input-wrapper { position: relative; }
    .input-wrapper i.left-icon { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 1.1rem; transition: color 0.3s; }
    .toggle-password { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: #9ca3af; cursor: pointer; font-size: 1rem; transition: color 0.2s; z-index: 10; }
    .toggle-password:hover { color: #0d6efd; }

    .form-control-custom { width: 100%; padding: 14px 45px 14px 50px; border: 2px solid #f3f4f6; border-radius: 12px; background: #f9fafb; font-size: 0.95rem; transition: all 0.2s; color: #1f2937; }
    .form-control-custom:focus { border-color: #0d6efd; background: #fff; outline: none; box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.1); }
    
    /* --- Buttons --- */
    .btn-submit { width: 100%; padding: 14px; border-radius: 12px; background: #0d6efd; color: white; font-weight: 600; border: none; font-size: 1rem; margin-top: 10px; transition: 0.3s; box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2); }
    .btn-submit:hover { background: #0b5ed7; transform: translateY(-1px); }
    
    .btn-google { width: 100%; padding: 12px; border-radius: 12px; background: white; color: #374151; border: 1px solid #e5e7eb; font-weight: 500; font-size: 0.95rem; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; margin-top: 20px; text-decoration: none; }
    .btn-google:hover { background: #f9fafb; border-color: #d1d5db; }
    .btn-google img { width: 20px; height: 20px; }
    
    .divider { display: flex; align-items: center; text-align: center; margin-top: 25px; color: #adb5bd; font-size: 0.8rem; }
    .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #e9ecef; }
    .divider:not(:empty)::before { margin-right: .5em; }
    .divider:not(:empty)::after { margin-left: .5em; }
</style>

<div class="login-wrapper">
    <div class="card-login">
        
        <div class="brand-icon">
            <i class="fas fa-utensils"></i>
        </div>

        <h3 class="welcome-title">Masuk Aplikasi</h3>
        <p class="welcome-subtitle">Sistem Monitoring Makan Bergizi Gratis</p>

        <div class="alert-container">
            {# 1. Menangani Flash Messages (Untuk alert Google Login Belum Terdaftar) #}
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert-custom">
                            <i class="fas fa-triangle-exclamation"></i>
                            <span>{{ message | safe }}</span>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {# 2. Menangani Pesan 'msg' Manual (Untuk login username/pass salah) #}
            {% if msg %}
                <div class="alert-custom">
                    <i class="fas fa-triangle-exclamation"></i>
                    <span>{{ msg | safe }}</span>
                </div>
            {% endif %}
        </div>

        <div class="nav nav-pills role-switch">
            <button class="nav-link {{ 'active' if active_tab == 'dapur' }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#nav-dapur">
                Admin Dapur
            </button>
            <button class="nav-link {{ 'active' if active_tab == 'gov' }}" 
                    data-bs-toggle="tab" 
                    data-bs-target="#nav-gov">
                Pengawas Gizi
            </button>
        </div>

        <div class="tab-content">
            <div class="tab-pane fade {{ 'show active' if active_tab == 'dapur' }}" id="nav-dapur">
                <form method="post">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="role" value="kitchen">

                    <div class="form-group">
                        <label class="form-label">Email Dapur</label>
                        <div class="input-wrapper">
                            <i class="fas fa-envelope left-icon"></i>
                            <input type="email" name="email" class="form-control-custom" placeholder="Masukkan Email" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kata Sandi</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock left-icon"></i>
                            <input type="password" name="password" id="pass-kitchen" class="form-control-custom" placeholder="Masukkan Kata Sandi" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePassword('pass-kitchen', this)"></i>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">Masuk</button>

                    <div class="divider">atau masuk dengan</div>

                    {# Tautan diperbaiki ke google_login #}
                    <a href="{{ url_for('authentication_blueprint.google_login', intent='login') }}" class="btn-google">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        Masuk dengan Google
                    </a>

                    <div class="mt-4 text-center">
                        <a href="{{ url_for('authentication_blueprint.register_choice') }}" class="text-decoration-none small">
                            Belum terdaftar? <span class="text-primary fw-bold">Registrasi Dapur</span>
                        </a>
                    </div>
                </form>
            </div>

            <div class="tab-pane fade {{ 'show active' if active_tab == 'gov' }}" id="nav-gov">
                <form method="post">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="role" value="government">

                    <div class="form-group">
                        <label class="form-label">NIP / ID Petugas</label>
                        <div class="input-wrapper">
                            <i class="fas fa-id-badge left-icon"></i>
                            <input type="text" name="username" class="form-control-custom" placeholder="Nomor Induk Pegawai" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kata Sandi</label>
                        <div class="input-wrapper">
                            <i class="fas fa-lock left-icon"></i>
                            <input type="password" name="password" id="pass-gov" class="form-control-custom" placeholder="Masukkan Kata Sandi" required>
                            <i class="fas fa-eye toggle-password" onclick="togglePassword('pass-gov', this)"></i>
                        </div>
                    </div>

                    <button type="submit" class="btn-submit">Masuk</button>

                    <!-- <div class="divider">opsi lain</div>

                    <a href="{{ url_for('authentication_blueprint.google_login') }}" class="btn-google">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                        Masuk dengan Google
                    </a> -->

                    <div class="mt-3 text-center">
                        <small class="text-muted fst-italic" style="font-size: 0.75rem;">
                            *Akses khusus pegawai dinas terkait MBG.
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function togglePassword(inputId, iconElement) {
        const passwordInput = document.getElementById(inputId);
        if (passwordInput.type === "password") {
            passwordInput.type = "text";
            iconElement.classList.remove('fa-eye');
            iconElement.classList.add('fa-eye-slash');
        } else {
            passwordInput.type = "password";
            iconElement.classList.remove('fa-eye-slash');
            iconElement.classList.add('fa-eye');
        }
    }
</script>

{% endblock content %}