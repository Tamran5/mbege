{% extends 'layouts/base.html' %}

{% block title %} Dashboard Dapur MBG {% endblock title %}

{% block content %}

    <div class="header bg-primary pb-6">
      <div class="container-fluid">
        <div class="header-body">
          <div class="row align-items-center py-4">
            <div class="col-lg-6 col-7">
              <h6 class="h2 text-white d-inline-block mb-0">Beranda Operasional</h6>
              <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                  <li class="breadcrumb-item"><a href="{{ url_for('home_blueprint.index') }}"><i class="fas fa-home text-white"></i></a></li>
                  <li class="breadcrumb-item active">{{ current_user.kitchen_name }}</li>
                </ol>
              </nav>
            </div>
          </div>
          
          <div class="row">
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats shadow border-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Total Siswa</h5>
                      <span class="h2 font-weight-bold mb-0 text-primary">{{ stats.total_siswa }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-blue text-white rounded-circle shadow">
                        <i class="fas fa-users"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats shadow border-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Verifikasi</h5>
                      <span class="h2 font-weight-bold mb-0 text-warning">{{ stats.antrian }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                        <i class="fas fa-user-clock"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6">
              <div class="card card-stats shadow border-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Porsi Hari Ini</h5>
                      <span class="h2 font-weight-bold mb-0 text-success">{{ stats.porsi }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                        <i class="fas fa-box"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-xl-3 col-md-6">
              <div class="card card-stats shadow border-0">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Kepuasan AI</h5>
                      <span class="h2 font-weight-bold mb-0 text-info">{{ stats.kepuasan }}</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                        <i class="fas fa-robot"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-fluid mt--6">
      <div class="row">
        <div class="col-xl-8">
          <div class="card bg-default shadow border-0">
            <div class="card-header bg-transparent border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-light text-uppercase ls-1 mb-1">Tren Distribusi</h6>
                  <h5 class="h3 text-white mb-0">Volume Mingguan (Porsi)</h5>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas id="chart-sales-dark" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-4">
          <div class="card shadow border-0">
            <div class="card-header bg-transparent border-0">
              <div class="row align-items-center">
                <div class="col">
                  <h6 class="text-uppercase text-muted ls-1 mb-1">Operasional</h6>
                  <h5 class="h3 mb-0">Target Volume</h5>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="chart">
                <canvas id="chart-bars" class="chart-canvas"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-xl-12">
          <div class="card shadow border-0">
            <div class="card-header border-0 shadow-sm">
              <div class="row align-items-center">
                <div class="col">
                  <h3 class="mb-0 text-primary"><i class="fas fa-truck-loading mr-2"></i>Kedatangan Terakhir</h3>
                </div>
                <div class="col text-right">
                  <a href="{{ url_for('home_blueprint.monitoring_kedatangan_view') }}" class="btn btn-sm btn-primary shadow-sm">Pantau Semua Sekolah</a>
                </div>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-items-center table-flush">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Nama Sekolah</th>
                    <th scope="col">Waktu Sampai</th>
                    <th scope="col">Jumlah Porsi</th>
                    <th scope="col">Foto Bukti</th>
                    <th scope="col">Status</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in arrivals %}
                  <tr>
                    <th scope="row">
                      <span class="font-weight-bold text-dark">{{ log.sekolah.school_name }}</span>
                    </th>
                    <td>{{ log.waktu_sampai.strftime('%H:%M') }} WIB</td>
                    <td>{{ log.porsi_sampai }} Porsi</td>
                    <td>
                      <a href="/static/uploads/distribusi/{{ log.foto_bukti }}" target="_blank" class="avatar avatar-sm rounded-circle shadow">
                        <img src="/static/uploads/distribusi/{{ log.foto_bukti }}" onerror="this.src='/static/assets/img/theme/no-image.jpg'">
                      </a>
                    </td>
                    <td>
                      <span class="badge badge-success shadow-sm">{{ log.status }}</span>
                    </td>
                  </tr>
                  {% else %}
                  <tr>
                    <td colspan="5" class="text-center py-5">
                      <p class="text-muted italic">Belum ada konfirmasi kedatangan sekolah untuk hari ini.</p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      {% include "includes/footer.html" %}

    </div>

{% endblock content %}

{% block javascripts %}
  <script src="/static/assets/vendor/chart.js/dist/Chart.min.js"></script>
  <script src="/static/assets/vendor/chart.js/dist/Chart.extension.js"></script>

  <script>
document.addEventListener("DOMContentLoaded", function () {
    const chartEl = document.getElementById("chart-sales-dark");
    if (!chartEl) return;

    new Chart(chartEl, {
        type: "line",
        data: {
            labels: {{ stats.chart_labels | tojson }},
            datasets: [{
                label: "Volume Distribusi",
                data: {{ stats.chart_data | tojson }},
                borderColor: "#5e72e4",
                backgroundColor: "transparent",
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    ticks: {
                        callback: function (value) {
                            return value + " Porsi";
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            return context.dataset.label + ": " + context.parsed.y + " Porsi";
                        }
                    }
                }
            }
        }
    });
});
</script>

{% endblock javascripts %}