{% extends 'layouts/base.html' %}

{% block title %} Edit Komposisi Menu - Standar MBG 2025 {% endblock title %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-7">
                    <h6 class="h2 text-white d-inline-block mb-0">Perencanaan Menu MBG</h6>
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('home_blueprint.daftar_katalog') }}">Katalog Menu</a></li>
                            <li class="breadcrumb-item active">Edit Komposisi</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-xl-4">
            <div class="card shadow border-0">
                <div class="card-header bg-transparent">
                    <h3 class="mb-0 text-uppercase"><i class="fas fa-chart-pie mr-2"></i>Analisis Menu</h3>
                </div>
                <div class="card-body pt-0">
                    <form id="form-edit-menu">
                        <input type="hidden" id="menu-id" value="{{ menu.id }}">

                        <div class="form-group mb-4">
                            <label class="form-control-label text-sm">Nama Paket Menu</label>
                            <input type="text" id="input-menu-name" class="form-control" value="{{ menu.menu_name }}" required>
                        </div>

                        <div class="p-3 rounded mb-4" style="background-color: #f6f9fc; border: 1px solid #e9ecef;">
                            <h6 class="text-uppercase text-muted ls-1 mb-3" style="font-size: 0.7rem;">Target Kontribusi Energi</h6>
                            
                            <div class="mb-3">
                                <div class="d-flex justify-content-between text-xs mb-1">
                                    <span>Energi Total:</span>
                                    <span id="summary-kcal" class="font-weight-bold text-primary">0 kkal</span>
                                </div>
                            </div>

                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-xs mb-1">
                                    <span>Protein (Target 10-15%):</span>
                                    <span id="pct-prot" class="font-weight-bold">0%</span>
                                </div>
                                <div class="progress progress-xs mb-0">
                                    <div id="bar-prot" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <div class="d-flex justify-content-between text-xs mb-1">
                                    <span>Lemak (Target 20-30%):</span>
                                    <span id="pct-fat" class="font-weight-bold">0%</span>
                                </div>
                                <div class="progress progress-xs mb-0">
                                    <div id="bar-fat" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="mb-0">
                                <div class="d-flex justify-content-between text-xs mb-1">
                                    <span>Karbohidrat (Target 55-65%):</span>
                                    <span id="pct-carb" class="font-weight-bold">0%</span>
                                </div>
                                <div class="progress progress-xs mb-0">
                                    <div id="bar-carb" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-0">
                            <label class="form-control-label text-sm">Foto Referensi Penyajian</label>
                            <div class="custom-file mb-3">
                                <input type="file" class="custom-file-input" id="input-photo" accept="image/*">
                                <label class="custom-file-label" for="input-photo">Unggah Foto QC</label>
                            </div>
                            <div class="text-center bg-secondary rounded p-2 border">
                                {% if menu.photo %}
                                    <img id="preview-image" src="{{ url_for('static', filename='assets/img/menus/' + menu.photo) }}" class="img-fluid rounded shadow-sm" style="max-height: 150px;">
                                {% else %}
                                    <img id="preview-image" src="" class="img-fluid rounded shadow-sm" style="max-height: 150px; display: none;">
                                    <div id="no-photo-text" class="py-4 text-muted text-xs">Belum ada foto referensi</div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <div class="card shadow border-0">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                    <h3 class="mb-0 text-uppercase">Rincian Komponen Piring</h3>
                    <button class="btn btn-sm btn-primary" data-toggle="modal" data-target="#modal-search-ingredient">
                        <i class="fas fa-plus mr-1"></i> Tambah Komponen
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table align-items-center table-flush" id="table-ingredients">
                        <thead class="thead-light">
                            <tr class="text-uppercase" style="font-size: 0.6rem;">
                                <th scope="col">Komponen</th>
                                <th scope="col" class="text-center">Berat (g)</th>
                                <th scope="col" class="text-center text-primary">Energi</th>
                                <th scope="col" class="text-center text-success">Prot (g)</th>
                                <th scope="col" class="text-center text-info">Lemak (g)</th>
                                <th scope="col" class="text-center">Fe (mg)</th>
                                <th scope="col" class="text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="ingredient-list-body">
                            {% for component in menu.components %}
                            <tr data-id="{{ component.ingredient_id }}" 
                                data-base-kcal="{{ component.ingredient_info.kcal }}"
                                data-base-prot="{{ component.ingredient_info.protein }}"
                                data-base-fat="{{ component.ingredient_info.fat }}"
                                data-base-carb="{{ component.ingredient_info.carb }}"
                                data-base-iron="{{ component.ingredient_info.iron|default(0) }}"
                                data-base-calcium="{{ component.ingredient_info.calcium|default(0) }}"
                                data-base-fiber="{{ component.ingredient_info.fiber|default(0) }}"
                                data-base-vita="{{ component.ingredient_info.vit_a|default(0) }}">
                                
                                <th scope="row" class="text-sm">
                                    <span class="font-weight-600 d-block">{{ component.ingredient_info.name }}</span>
                                    <small class="text-muted">{{ component.ingredient_info.category }}</small>
                                </th>
                                <td class="text-center" style="width: 100px;">
                                    <input type="number" class="form-control form-control-sm text-center input-weight" 
                                           value="{{ component.weight|int }}" onchange="recalculateRow(this)" onkeyup="recalculateRow(this)">
                                </td>
                                <td class="text-center font-weight-bold val-kcal">{{ "%.1f"|format(component.weight * component.ingredient_info.kcal / 100) }}</td>
                                <td class="text-center font-weight-bold val-prot text-success">{{ "%.1f"|format(component.weight * component.ingredient_info.protein / 100) }}</td>
                                <td class="text-center val-fat text-info">{{ "%.1f"|format(component.weight * component.ingredient_info.fat / 100) }}</td>
                                <td class="text-center val-iron">{{ "%.1f"|format(component.weight * (component.ingredient_info.iron|default(0)) / 100) }}</td>
                                <input type="hidden" class="val-carb" value="{{ (component.weight * component.ingredient_info.carb / 100) }}">
                                <input type="hidden" class="val-fiber" value="{{ (component.weight * (component.ingredient_info.fiber|default(0)) / 100) }}">
                                <input type="hidden" class="val-calcium" value="{{ (component.weight * (component.ingredient_info.calcium|default(0)) / 100) }}">
                                <input type="hidden" class="val-vita" value="{{ (component.weight * (component.ingredient_info.vit_a|default(0)) / 100) }}">
                                <td class="text-center">
                                    <button class="btn btn-sm btn-link text-danger p-0" onclick="removeRow(this)"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-secondary">
                            <tr class="font-weight-bold text-dark" style="font-size: 0.75rem;">
                                <td>TOTAL PER PORSI</td>
                                <td class="text-center" id="total-weight">0 g</td>
                                <td class="text-center text-primary" id="total-kcal">0 kkal</td>
                                <td class="text-center text-success" id="total-prot">0 g</td>
                                <td class="text-center text-info" id="total-fat">0 g</td>
                                <td class="text-center" id="total-iron">0 mg</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="card-footer py-3 bg-white border-0 d-flex justify-content-between">
                    <a href="{{ url_for('home_blueprint.daftar_katalog') }}" class="btn btn-neutral btn-sm px-4">Batal</a>
                    <button class="btn btn-primary btn-sm px-4 shadow-lg" onclick="saveMenuChanges()">Simpan Komposisi 2025</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modal-search-ingredient" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title font-weight-bold">TAMBAH KOMPONEN PANGAN</h5>
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body bg-secondary pt-0">
                <div class="form-group mb-3">
                    <div class="input-group input-group-alternative">
                        <div class="input-group-prepend"><span class="input-group-text"><i class="fas fa-search"></i></span></div>
                        <input class="form-control text-sm" placeholder="Ketik nama komponen (misal: Ayam, Ikan...)" type="text" id="search-input" onkeyup="searchIngredients()">
                    </div>
                </div>
                <div class="list-group shadow-sm" id="search-results" style="max-height: 250px; overflow-y: auto;">
                    <div class="text-center text-muted py-3 text-sm bg-white">Cari komponen pangan...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        updateGrandTotal();
    });

    function recalculateRow(input) {
        const row = input.closest('tr');
        const weight = parseFloat(input.value) || 0;
        const ratio = weight / 100;
        
        row.querySelector('.val-kcal').innerText = (ratio * parseFloat(row.dataset.baseKcal)).toFixed(1);
        row.querySelector('.val-prot').innerText = (ratio * parseFloat(row.dataset.baseProt)).toFixed(1);
        row.querySelector('.val-fat').innerText = (ratio * parseFloat(row.dataset.baseFat)).toFixed(1);
        row.querySelector('.val-iron').innerText = (ratio * parseFloat(row.dataset.baseIron)).toFixed(1);
        row.querySelector('.val-carb').value = (ratio * parseFloat(row.dataset.baseCarb)).toFixed(1);
        row.querySelector('.val-fiber').value = (ratio * parseFloat(row.dataset.baseFiber)).toFixed(1);
        row.querySelector('.val-calcium').value = (ratio * parseFloat(row.dataset.baseCalcium)).toFixed(1);
        row.querySelector('.val-vita').value = (ratio * parseFloat(row.dataset.baseVita)).toFixed(1);

        updateGrandTotal();
    }

    function updateGrandTotal() {
        let tWeight = 0, tKcal = 0, tProt = 0, tFat = 0, tCarb = 0, tIron = 0, tCal = 0, tFiber = 0, tVita = 0;

        document.querySelectorAll("#table-ingredients tbody tr").forEach(row => {
            tWeight += parseFloat(row.querySelector('.input-weight').value) || 0;
            tKcal += parseFloat(row.querySelector('.val-kcal').innerText) || 0;
            tProt += parseFloat(row.querySelector('.val-prot').innerText) || 0;
            tFat += parseFloat(row.querySelector('.val-fat').innerText) || 0;
            tCarb += parseFloat(row.querySelector('.val-carb').value) || 0;
            tIron += parseFloat(row.querySelector('.val-iron').innerText) || 0;
            tCal += parseFloat(row.querySelector('.val-calcium').value) || 0;
            tFiber += parseFloat(row.querySelector('.val-fiber').value) || 0;
            tVita += parseFloat(row.querySelector('.val-vita').value) || 0;
        });

        document.getElementById('total-weight').innerText = tWeight.toFixed(0) + " g";
        document.getElementById('total-kcal').innerText = tKcal.toFixed(0) + " kkal";
        document.getElementById('total-prot').innerText = tProt.toFixed(1) + " g";
        document.getElementById('total-fat').innerText = tFat.toFixed(1) + " g";
        document.getElementById('total-iron').innerText = tIron.toFixed(1) + " mg";
        
        // Update Summary Dashboard
        document.getElementById('summary-kcal').innerText = tKcal.toFixed(0) + " kkal";
        
        if (tKcal > 0) {
            const pProt = ((tProt * 4) / tKcal * 100).toFixed(1);
            const pFat = ((tFat * 9) / tKcal * 100).toFixed(1);
            const pCarb = ((tCarb * 4) / tKcal * 100).toFixed(1);

            document.getElementById('pct-prot').innerText = pProt + "%";
            document.getElementById('bar-prot').style.width = pProt + "%";
            
            document.getElementById('pct-fat').innerText = pFat + "%";
            document.getElementById('bar-fat').style.width = pFat + "%";
            
            document.getElementById('pct-carb').innerText = pCarb + "%";
            document.getElementById('bar-carb').style.width = pCarb + "%";
        }
    }

    // Fungsi cari, pilih, dan simpan tetap serupa namun diperluas untuk semua field nutrisi mikro
    function searchIngredients() {
        const query = document.getElementById('search-input').value;
        const resultsDiv = document.getElementById('search-results');
        if(query.length < 2) return;

        fetch(`/api/cari-bahan-master?q=${query}`)
            .then(res => res.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                data.forEach(item => {
                    const btn = document.createElement('button');
                    btn.className = "list-group-item list-group-item-action text-sm";
                    btn.innerHTML = `<b>${item.name}</b> <br> <small class="text-muted">${item.category}</small>`;
                    btn.onclick = () => { selectIngredient(item); };
                    resultsDiv.appendChild(btn);
                });
            });
    }

    function selectIngredient(item) {
        const tbody = document.getElementById('ingredient-list-body');
        const tr = document.createElement('tr');
        tr.dataset.id = item.id;
        tr.dataset.baseKcal = item.kcal;
        tr.dataset.baseProt = item.prot;
        tr.dataset.baseFat = item.fat;
        tr.dataset.baseCarb = item.carb;
        tr.dataset.baseIron = item.iron || 0;
        tr.dataset.baseCalcium = item.calcium || 0;
        tr.dataset.baseFiber = item.fiber || 0;
        tr.dataset.baseVita = item.vit_a || 0;

        tr.innerHTML = `
            <th scope="row" class="text-sm"><span class="font-weight-600 d-block">${item.name}</span><small class="text-muted">${item.category}</small></th>
            <td class="text-center" style="width: 100px;"><input type="number" class="form-control form-control-sm text-center input-weight" value="100" onchange="recalculateRow(this)" onkeyup="recalculateRow(this)"></td>
            <td class="text-center font-weight-bold val-kcal">${item.kcal}</td>
            <td class="text-center font-weight-bold val-prot text-success">${item.prot}</td>
            <td class="text-center val-fat text-info">${item.fat}</td>
            <td class="text-center val-iron">${item.iron || 0}</td>
            <input type="hidden" class="val-carb" value="${item.carb}">
            <input type="hidden" class="val-fiber" value="${item.fiber || 0}">
            <input type="hidden" class="val-calcium" value="${item.calcium || 0}">
            <input type="hidden" class="val-vita" value="${item.vit_a || 0}">
            <td class="text-center"><button class="btn btn-sm btn-link text-danger p-0" onclick="removeRow(this)"><i class="fas fa-trash"></i></button></td>
        `;
        tbody.appendChild(tr);
        $('#modal-search-ingredient').modal('hide');
        updateGrandTotal();
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        updateGrandTotal();
    }

    function saveMenuChanges() {
        const formData = new FormData();
        formData.append('id', document.getElementById('menu-id').value);
        formData.append('menu_name', document.getElementById('input-menu-name').value);
        
        let components = [];
        let tKcal = 0, tProt = 0, tFat = 0, tCarb = 0, tFiber = 0, tIron = 0, tCal = 0, tVita = 0;

        document.querySelectorAll("#table-ingredients tbody tr").forEach(row => {
            const w = parseFloat(row.querySelector('.input-weight').value);
            components.push({ ingredient_id: row.dataset.id, weight: w });
            
            tKcal += parseFloat(row.querySelector('.val-kcal').innerText);
            tProt += parseFloat(row.querySelector('.val-prot').innerText);
            tFat += parseFloat(row.querySelector('.val-fat').innerText);
            tCarb += parseFloat(row.querySelector('.val-carb').value);
            tFiber += parseFloat(row.querySelector('.val-fiber').value);
            tIron += parseFloat(row.querySelector('.val-iron').innerText);
            tCal += parseFloat(row.querySelector('.val-calcium').value);
            tVita += parseFloat(row.querySelector('.val-vita').value);
        });

        formData.append('components', JSON.stringify(components));
        formData.append('total_kcal', tKcal);
        formData.append('total_protein', tProt);
        formData.append('total_fat', tFat);
        formData.append('total_carb', tCarb);
        formData.append('total_fiber', tFiber);
        formData.append('total_iron', tIron);
        formData.append('total_calcium', tCal);
        formData.append('total_vit_a', tVita);

        const photo = document.getElementById('input-photo').files[0];
        if(photo) formData.append('photo', photo);

        fetch('/api/update-menu-mbg', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') location.href = "{{ url_for('home_blueprint.daftar_katalog') }}";
                else alert("Gagal: " + data.message);
            });
    }

    // Logic preview foto
    document.getElementById('input-photo').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('preview-image').style.display = 'block';
                if(document.getElementById('no-photo-text')) document.getElementById('no-photo-text').style.display = 'none';
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });
</script>
{% endblock javascripts %}