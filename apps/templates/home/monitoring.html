{% extends 'layouts/base.html' %}

{% block title %} Dashboard Operasional Dapur {% endblock title %}

{% block stylesheets %}
<link rel="stylesheet" href="/static/assets/css/monitoring.css">
<style>
    .camera-container {
        position: relative; width: 100%; min-height: 250px; background: #f8f9fe;
        border: 2px dashed #dee2e6; border-radius: 15px; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
    }
    #videoElement, #photoPreview { width: 100%; height: auto; display: none; border-radius: 10px; }
    .alert-rejection { background-color: #fff5f5; border-left: 4px solid #f5365c; padding: 10px; margin-top: 8px; border-radius: 4px; border: 1px solid #fad2d2; }
</style>
{% endblock stylesheets %}

{% block content %}

<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6">
                    <h6 class="h2 text-white d-inline-block mb-0">Halo, {{ current_user.username }}!</h6>
                    <p class="text-white opacity-8 mb-0">Update progres masak harian dapur Anda.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-3 col-md-6">
                    <div class="card card-stats shadow">
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <h5 class="card-title text-uppercase text-muted mb-0">Target Porsi</h5>
                                    <span class="h2 font-weight-bold mb-0">{{ target_porsi or '0' }}</span>
                                </div>
                                <div class="col-auto">
                                    <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                                        <i class="fas fa-users"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-4 col-md-6">
                    <div class="card card-stats shadow">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col">
                                    <h5 class="card-title text-uppercase text-muted mb-0">Jam Sistem</h5>
                                    <span class="h2 font-weight-bold mb-0" id="clockDisplay">00:00:00</span>
                                </div>
                                <div class="col-auto">
                                    <div class="icon icon-shape bg-gradient-primary text-white rounded-circle shadow">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-xl-5">
            <div class="card shadow">
                <div class="card-header bg-white border-0">
                    <h3 class="mb-0">Update Progres Masak</h3>
                </div>
                <div class="card-body">
                    <form id="kitchenForm">
                        <div class="form-group">
                            <label class="form-control-label">Tahapan Proses</label>
                            <select id="processInput" class="form-control text-dark font-weight-bold" required>
                                <option value="" disabled selected>Pilih aktivitas...</option>
                                <option value="Persiapan Bahan">Persiapan Bahan</option>
                                <option value="Pengolahan/Memasak">Pengolahan/Memasak</option>
                                <option value="Quality Control">Quality Control</option>
                                <option value="Pengemasan">Pengemasan</option>
                                <option value="Distribusi">Distribusi</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-control-label">Ambil Bukti Foto (Real-time)</label>
                            <div class="camera-container" id="cameraBox">
                                <div id="cameraPlaceholder" class="text-center">
                                    <i class="fas fa-camera fa-3x text-muted mb-2"></i>
                                    <p class="text-sm">Gunakan kamera untuk bukti valid</p>
                                    <button type="button" class="btn btn-sm btn-primary" onclick="startCamera()">Aktifkan Kamera</button>
                                </div>
                                <video id="videoElement" autoplay playsinline></video>
                                <canvas id="canvasElement" style="display:none;"></canvas>
                                <img id="photoPreview" src="">
                            </div>

                            <div class="row mt-3" id="cameraControls" style="display:none;">
                                <div class="col-6">
                                    <button type="button" class="btn btn-warning btn-block shadow" onclick="takePhoto()">Jepret</button>
                                </div>
                                <div class="col-6">
                                    <button type="button" class="btn btn-secondary btn-block shadow" onclick="resetCamera()">Ulang</button>
                                </div>
                            </div>
                            <input type="hidden" id="photoData" required>
                        </div>

                        <button type="submit" class="btn btn-primary btn-block btn-lg mt-4 shadow">
                            <i class="fas fa-paper-plane mr-2"></i>Kirim Laporan
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-xl-7">
            <div class="card shadow">
                <div class="card-header border-0">
                    <h3 class="mb-0">Riwayat Aktivitas Hari Ini</h3>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                            <tr>
                                <th>Jam</th>
                                <th>Aktivitas</th>
                                <th>Bukti</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for act in activities %}
                            <tr>
                                <td class="font-weight-bold">{{ act.waktu_mulai.strftime('%H:%M') }}</td>
                                <td>{{ act.jenis_aktivitas }}</td>
                                <td>
                                    <a href="/static/uploads/activities/{{ act.bukti_foto }}" target="_blank" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-image mr-1"></i>Lihat
                                    </a>
                                </td>
                                <td>
                                    {# Sinkronisasi status dengan backend (proses/selesai/ditolak) #}
                                    {% set status_clean = act.status|lower %}
                                    {% if status_clean == 'proses' %}
                                        <span class="badge badge-warning">Menunggu Validasi</span>
                                    {% elif status_clean == 'selesai' %}
                                        <span class="badge badge-success">Disetujui</span>
                                    {% elif status_clean == 'ditolak' %}
                                        <span class="badge badge-danger">Ditolak</span>
                                        <div class="alert-rejection shadow-sm">
                                            <small class="text-danger font-weight-bold">Alasan:</small><br>
                                            <small>{{ act.catatan or 'Data foto tidak sesuai standar QC.' }}</small>
                                        </div>
                                    {% else %}
                                        <span class="badge badge-secondary">{{ act.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr><td colspan="4" class="text-center py-4 text-muted">Belum ada aktivitas yang dicatat hari ini.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block javascripts %}
<script>
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvasElement');
    const photoPreview = document.getElementById('photoPreview');
    const photoDataInput = document.getElementById('photoData');
    const cameraPlaceholder = document.getElementById('cameraPlaceholder');
    const cameraControls = document.getElementById('cameraControls');

    // Jam Real-time
    setInterval(() => {
        document.getElementById('clockDisplay').textContent = new Date().toLocaleTimeString('en-GB');
    }, 1000);

    // Fungsi Kamera
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            cameraPlaceholder.style.display = 'none';
            cameraControls.style.display = 'flex';
        } catch (err) { alert("Kamera tidak ditemukan atau akses ditolak."); }
    }

    function takePhoto() {
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        const dataURL = canvas.toDataURL('image/jpeg');
        photoDataInput.value = dataURL;
        photoPreview.src = dataURL;
        photoPreview.style.display = 'block';
        video.style.display = 'none';
    }

    function resetCamera() {
        photoDataInput.value = "";
        photoPreview.style.display = 'none';
        video.style.display = 'block';
    }

    // Submit Laporan
    document.getElementById('kitchenForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const payload = {
            process: document.getElementById('processInput').value,
            photo: photoDataInput.value
        };

        if(!payload.photo) return alert("Harap ambil foto bukti terlebih dahulu!");

        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Mengirim...';

        try {
            const response = await fetch('/api/submit-activity', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if(response.status === 201) {
                location.reload(); 
            } else {
                alert("Gagal: " + result.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Kirim Laporan';
            }
        } catch (err) {
            alert("Terjadi kesalahan koneksi.");
            btn.disabled = false;
        }
    });
</script>
{% endblock javascripts %}