{% extends 'layouts/base.html' %}

{% block title %} Tambah Menu Baru {% endblock title %}

{% block content %}
<div class="header bg-primary pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-7 col-7">
          <h6 class="h2 text-white d-inline-block mb-0">Manajemen Menu</h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item"><a href="{{ url_for('home_blueprint.daftar_katalog') }}">Database Menu</a></li>
              <li class="breadcrumb-item active" aria-current="page">Tambah Baru</li>
            </ol>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt--6">
  <div class="row">
    
    <div class="col-xl-4">
      <div class="card shadow border-0">
        <div class="card-header bg-transparent">
          <h3 class="mb-0">Informasi Utama</h3>
        </div>
        <div class="card-body">
          <form id="form-new-menu">
            <div class="form-group mb-4">
              <label class="form-control-label">Nama Menu Makanan</label>
              <input type="text" id="input-menu-name" class="form-control form-control-alternative" placeholder="Contoh: Ayam Bakar Madu" required>
            </div>
            
            <div class="form-group mb-4">
              <label class="form-control-label">Foto Menu</label>
              <div class="input-group">
                <div class="custom-file">
                  <input type="file" class="custom-file-input" id="input-photo" accept="image/*">
                  <label class="custom-file-label" for="input-photo">Pilih Foto</label>
                </div>
              </div>
              <small class="text-muted mt-2 d-block">Format: JPG, PNG. Maks 2MB.</small>
            </div>

            <div class="mt-3 text-center" id="image-preview-container" style="display: none;">
                <img id="image-preview" src="" class="img-fluid rounded shadow-sm border" style="max-height: 200px;">
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-xl-8">
      <div class="card shadow border-0">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
          <h3 class="mb-0">Komposisi Bahan</h3>
          <button class="btn btn-sm btn-info shadow-none" data-toggle="modal" data-target="#modal-search-ingredient">
            <i class="fas fa-search mr-1"></i> Cari & Tambah Bahan
          </button>
        </div>

        <div class="table-responsive">
          <table class="table align-items-center table-flush" id="table-ingredients">
            <thead class="thead-light">
              <tr class="text-uppercase" style="font-size: 0.65rem; letter-spacing: 0.5px;">
                <th scope="col" class="py-3">Nama Bahan</th>
                <th scope="col" class="text-center">Berat (gr)</th>
                <th scope="col" class="text-center">Kcal</th>
                <th scope="col" class="text-center">Prot (g)</th>
                <th scope="col" class="text-center">Lemak (g)</th>
                <th scope="col" class="text-center">Aksi</th>
              </tr>
            </thead>
            <tbody class="list" id="ingredient-list-body">
              <tr id="empty-row">
                <td colspan="6" class="text-center py-5">
                    <div class="text-muted font-italic">
                        <i class="fas fa-basket-shopping mb-2"></i><br>
                        Belum ada bahan yang dipilih. Klik tombol <strong>Cari & Tambah Bahan</strong>.
                    </div>
                </td>
              </tr>
            </tbody>
            
            <tfoot class="bg-secondary">
              <tr class="font-weight-bold" style="color: #32325d;">
                <td class="text-uppercase py-3" style="font-size: 0.75rem;">Estimasi Total Gizi</td>
                <td class="text-center py-3" id="total-weight">0 gr</td>
                <td class="text-center py-3 text-primary font-weight-700" id="total-kcal">0 kcal</td>
                <td class="text-center py-3 text-success font-weight-700" id="total-prot">0 g</td>
                <td class="text-center py-3 text-danger font-weight-700" id="total-fat">0 g</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>

        <div class="card-footer py-4 d-flex justify-content-between bg-white border-0 mt-2">
          <a href="{{ url_for('home_blueprint.daftar_katalog') }}" class="btn btn-neutral btn-sm px-4">Batal</a>
          <button class="btn btn-primary btn-sm px-4 shadow" onclick="saveNewMenu()">Simpan Menu</button>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>

<div class="modal fade" id="modal-search-ingredient" tabindex="-1" role="dialog" aria-labelledby="modal-search-ingredient" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cari Bahan Baku</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mb-3">
                    <div class="input-group input-group-merge input-group-alternative">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input class="form-control" placeholder="Ketik nama bahan (misal: Beras, Ayam)..." type="text" id="search-input" onkeyup="searchIngredients()">
                    </div>
                </div>
                <div class="list-group" id="search-results" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted py-3 text-sm">Mulai ketik untuk mencari...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script>
    // 1. PREVIEW FOTO
    document.getElementById('input-photo').addEventListener('change', function(e) {
        if (e.target.files && e.target.files[0]) {
            let reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('image-preview').src = e.target.result;
                document.getElementById('image-preview-container').style.display = 'block';
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });

    // 2. FUNGSI PENCARIAN BAHAN (Fetch API)
    let searchTimeout;
    function searchIngredients() {
        clearTimeout(searchTimeout);
        const query = document.getElementById('search-input').value;
        const resultsDiv = document.getElementById('search-results');

        if(query.length < 2) {
            resultsDiv.innerHTML = '<div class="text-center text-muted py-3 text-sm">Ketik minimal 2 huruf...</div>';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/cari-bahan-master?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    resultsDiv.innerHTML = '';
                    if(data.length === 0) {
                        resultsDiv.innerHTML = '<div class="text-center text-muted py-3 text-sm">Bahan tidak ditemukan.</div>';
                        return;
                    }
                    data.forEach(item => {
                        // Membuat elemen list item
                        const btn = document.createElement('button');
                        btn.className = "list-group-item list-group-item-action d-flex justify-content-between align-items-center";
                        btn.innerHTML = `
                            <div>
                                <span class="font-weight-bold text-sm text-dark">${item.name}</span>
                                <br>
                                <span class="text-xs text-muted">${item.category} | ${item.kcal} kcal/100g</span>
                            </div>
                            <i class="fas fa-plus-circle text-primary"></i>
                        `;
                        // Event saat dipilih
                        btn.onclick = () => { selectIngredient(item); };
                        resultsDiv.appendChild(btn);
                    });
                });
        }, 500); // Delay 500ms agar tidak spam request
    }

    // 3. FUNGSI MEMILIH BAHAN DAN MASUK TABEL
    function selectIngredient(item) {
        const tbody = document.getElementById('ingredient-list-body');
        
        // Hapus empty row jika ada
        const emptyRow = document.getElementById('empty-row');
        if(emptyRow) emptyRow.remove();

        // Cek apakah sudah ada (opsional, boleh double kalau mau)
        // ...

        const tr = document.createElement('tr');
        // Simpan data base nutrition di atribut data HTML
        tr.dataset.id = item.id;
        tr.dataset.baseKcal = item.kcal;
        tr.dataset.baseProt = item.prot;
        tr.dataset.baseFat = item.fat;

        tr.innerHTML = `
            <th scope="row" class="text-sm font-weight-600">${item.name}</th>
            <td class="text-center" style="width: 140px;">
                <input type="number" class="form-control form-control-sm text-center border-light shadow-none input-weight" 
                       value="100" min="1" onchange="recalculateRow(this)" onkeyup="recalculateRow(this)">
            </td>
            <td class="text-center text-muted val-kcal">${Math.round(item.kcal)}</td>
            <td class="text-center text-muted val-prot">${item.prot}</td>
            <td class="text-center text-muted val-fat">${item.fat}</td>
            <td class="text-center">
                <button class="btn btn-sm btn-icon-only text-danger bg-transparent border-0" onclick="removeRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
        $('#modal-search-ingredient').modal('hide'); // Tutup modal (perlu jQuery bootstrap)
        
        updateGrandTotal();
    }

    // 4. HITUNG ULANG BARIS (Saat berat diubah)
    function recalculateRow(input) {
        const row = input.closest('tr');
        let weight = parseFloat(input.value);
        
        if (isNaN(weight) || weight < 0) weight = 0;

        const baseKcal = parseFloat(row.dataset.baseKcal);
        const baseProt = parseFloat(row.dataset.baseProt);
        const baseFat  = parseFloat(row.dataset.baseFat);

        // Rumus: (Berat / 100) * Nilai Dasar
        const newKcal = (weight / 100) * baseKcal;
        const newProt = (weight / 100) * baseProt;
        const newFat  = (weight / 100) * baseFat;

        row.querySelector('.val-kcal').innerText = Math.round(newKcal);
        row.querySelector('.val-prot').innerText = newProt.toFixed(1);
        row.querySelector('.val-fat').innerText  = newFat.toFixed(1);

        updateGrandTotal();
    }

    // 5. UPDATE TOTAL KESELURUHAN (Footer Table)
    function updateGrandTotal() {
        let tWeight = 0, tKcal = 0, tProt = 0, tFat = 0;

        document.querySelectorAll("#table-ingredients tbody tr").forEach(row => {
            if(row.id === 'empty-row') return;

            const w = parseFloat(row.querySelector('.input-weight').value) || 0;
            tWeight += w;
            tKcal += parseFloat(row.querySelector('.val-kcal').innerText) || 0;
            tProt += parseFloat(row.querySelector('.val-prot').innerText) || 0;
            tFat  += parseFloat(row.querySelector('.val-fat').innerText) || 0;
        });

        document.getElementById('total-weight').innerText = tWeight + " gr";
        document.getElementById('total-kcal').innerText = Math.round(tKcal) + " kcal";
        document.getElementById('total-prot').innerText = tProt.toFixed(1) + " g";
        document.getElementById('total-fat').innerText = tFat.toFixed(1) + " g";
    }

    // 6. HAPUS BARIS
    function removeRow(btn) {
        btn.closest('tr').remove();
        // Cek jika kosong, tampilkan empty row lagi
        const tbody = document.getElementById('ingredient-list-body');
        if(tbody.children.length === 0) {
            tbody.innerHTML = `<tr id="empty-row"><td colspan="6" class="text-center py-5"><div class="text-muted font-italic">Belum ada bahan.</div></td></tr>`;
        }
        updateGrandTotal();
    }

    // 7. SIMPAN MENU KE DATABASE
    function saveNewMenu() {
        const menuName = document.getElementById('input-menu-name').value;
        const photoFile = document.getElementById('input-photo').files[0];
        
        // Validasi
        if (!menuName) { alert("Nama menu wajib diisi!"); return; }

        // Ambil Data Bahan
        let ingredients = [];
        let hasIngredients = false;
        document.querySelectorAll("#table-ingredients tbody tr").forEach(row => {
            if(row.id === 'empty-row') return;
            hasIngredients = true;
            ingredients.push({
                id: row.dataset.id,
                weight: parseFloat(row.querySelector('.input-weight').value)
            });
        });

        if (!hasIngredients) { alert("Tambahkan minimal satu bahan!"); return; }

        // Siapkan FormData
        let formData = new FormData();
        formData.append('menu_name', menuName);
        if (photoFile) formData.append('photo', photoFile);

        // Ambil Total Akhir (text diambil, split spasi untuk buang unit)
        formData.append('total_kcal', document.getElementById('total-kcal').innerText.split(' ')[0]);
        formData.append('total_prot', document.getElementById('total-prot').innerText.split(' ')[0]);
        formData.append('total_fat', document.getElementById('total-fat').innerText.split(' ')[0]);
        formData.append('total_carb', 0); // Jika mau hitung karbo, tambah logika kolom karbo

        formData.append('ingredients', JSON.stringify(ingredients));

        // Kirim Fetch
        fetch('/api/simpan-menu-katalog', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                alert("Menu berhasil dibuat!");
                window.location.href = "{{ url_for('home_blueprint.daftar_katalog') }}";
            } else {
                alert("Gagal: " + data.message);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Terjadi kesalahan server.");
        });
    }
</script>
{% endblock javascripts %}