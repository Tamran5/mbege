{% extends 'layouts/base.html' %}

{% block title %} Monitoring Kedatangan Makanan {% endblock title %}

{% block content %}
<div class="header bg-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">Log Distribusi Makanan</h6>
                </div>
                <div class="col-lg-6 col-5 text-right">
                    <div class="d-flex align-items-center justify-content-end">
                        {% if request.args.get('date') %}
                        <a href="{{ url_for('home_blueprint.monitoring_kedatangan_view') }}" 
                           class="btn btn-sm btn-danger mr-2 shadow-sm">
                           <i class="fas fa-times mr-1"></i> Hapus Filter
                        </a>
                        {% endif %}

                        <div class="form-group mb-0">
                            <div class="input-group input-group-alternative input-group-sm border-0 shadow-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text"><i class="ni ni-calendar-grid-58 text-primary"></i></span>
                                </div>
                                <input class="form-control" type="date" 
                                       id="filterTanggal" onchange="filterByDate()" 
                                       value="{{ request.args.get('date', '') }}"
                                       style="font-weight: bold; color: #525f7f;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-xl-4 col-md-6">
                    <div class="card card-stats shadow-sm">
                        <div class="card-body">
                            <div class="row">
                                <div class="col">
                                    <h5 class="card-title text-uppercase text-muted mb-0">Status Pengiriman</h5>
                                    <span class="h2 font-weight-bold mb-0">
                                        {% if request.args.get('date') %}
                                            {{ request.args.get('date') }}
                                        {% else %}
                                            Hari Ini
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="col-auto">
                                    <div class="icon icon-shape bg-gradient-info text-white rounded-circle shadow">
                                        <i class="fas fa-truck-loading"></i>
                                    </div>
                                </div>
                            </div>
                            <p class="mt-3 mb-0 text-sm">
                                <span class="text-success mr-2"><i class="fa fa-check"></i> {{ kedatangan|length }}</span>
                                <span class="text-nowrap">Sekolah Berhasil Konfirmasi</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        <div class="col-xl-7">
            <div class="card shadow border-0">
                <div class="card-header border-0">
                    <h3 class="mb-0 text-primary"><i class="fas fa-list-ul mr-2"></i>Riwayat Distribusi</h3>
                </div>
                <div class="table-responsive">
                    <table class="table align-items-center table-flush">
                        <thead class="thead-light">
                            <tr>
                                <th>Sekolah / Penerima</th>
                                <th>Waktu Sampai</th>
                                <th>Status</th>
                                <th class="text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in kedatangan %}
                            <tr>
                                <td>
                                    <span class="font-weight-bold text-dark">{{ item.sekolah.school_name }}</span><br>
                                    <small class="text-muted">NPSN: {{ item.sekolah.npsn }}</small>
                                </td>
                                <td>{{ item.waktu_sampai.strftime('%H:%M') }} WIB</td>
                                <td>
                                    <span class="badge badge-pill badge-success">DITERIMA</span>
                                </td>
                                <td class="text-right">
                                    {% set a_data = {
                                        'school_name': item.sekolah.school_name,
                                        'arrival_time': item.waktu_sampai.strftime('%H:%M %d/%m/%Y'),
                                        'photo': item.foto_bukti,
                                        'operator': item.sekolah.fullname,
                                        'porsi': item.porsi_sampai
                                    } %}
                                    <button class="btn btn-sm btn-primary shadow-sm" 
                                            data-arrival='{{ a_data | tojson | safe }}' 
                                            onclick="viewArrival(this)">
                                        <i class="fas fa-eye mr-1"></i> Detail
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <img src="/static/assets/img/theme/no-data.svg" style="width: 100px;" class="mb-3 opacity-5"><br>
                                    <p class="text-muted italic">Tidak ada rekaman pengiriman makanan untuk tanggal ini.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-xl-5">
            <div class="card bg-secondary shadow border-0" id="detailArea" style="display: none;">
                <div class="card-header bg-white border-0">
                    <div class="row align-items-center">
                        <div class="col-8"><h3 class="mb-0 text-primary">Bukti Kedatangan</h3></div>
                        <div class="col-4 text-right">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="closeDetail()">Tutup</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h2 class="mb-0 font-weight-bold" id="dispSchool" style="color: #1a237e;">-</h2>
                        <p class="text-muted mb-0" id="dispTime">-</p>
                    </div>

                    <div class="card shadow border-0 mb-4 overflow-hidden">
                        <img id="imgBukti" src="" class="img-fluid" style="width: 100%; height: 280px; object-fit: cover; cursor: pointer;" onclick="zoomImage()">
                        <div class="card-body p-3 bg-white border-top">
                            <div class="row">
                                <div class="col-6 border-right text-center">
                                    <small class="text-muted text-uppercase font-weight-bold d-block" style="font-size: 0.65rem;">Porsi Diterima</small>
                                    <span class="h3 font-weight-bold text-primary" id="detPorsi">0</span>
                                </div>
                                <div class="col-6 text-center">
                                    <small class="text-muted text-uppercase font-weight-bold d-block" style="font-size: 0.65rem;">Petugas Sekolah</small>
                                    <span class="h4 font-weight-bold text-dark" id="detOperator">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info py-2 shadow-sm border-0">
                        <small><i class="fas fa-info-circle mr-2"></i>Foto ini dikirim otomatis oleh aplikasi mobile saat serah terima.</small>
                    </div>
                </div>
            </div>

            <div class="card shadow border-0 text-center p-5" id="noDataPlaceholder">
                <div class="py-5">
                    <div class="icon icon-shape bg-soft-primary text-primary rounded-circle mb-4">
                        <i class="ni ni-zoom-split-in"></i>
                    </div>
                    <p class="text-muted">Klik tombol <b>Detail</b> di daftar riwayat untuk meninjau foto bukti pengiriman.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalZoom" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-body text-center p-1">
                <img id="imgZoom" src="" class="img-fluid rounded">
                <button type="button" class="btn btn-sm btn-secondary mt-3" data-dismiss="modal">Kembali</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    // FUNGSI FILTER KALENDER
    function filterByDate() {
        const val = document.getElementById('filterTanggal').value;
        if (val) {
            window.location.href = "{{ url_for('home_blueprint.monitoring_kedatangan_view') }}?date=" + val;
        }
    }

    // TAMPILKAN DETAIL
    function viewArrival(btn) {
        try {
            const data = JSON.parse(btn.getAttribute('data-arrival'));
            
            document.getElementById('detailArea').style.display = 'block';
            document.getElementById('noDataPlaceholder').style.display = 'none';

            document.getElementById('dispSchool').innerText = data.school_name;
            document.getElementById('dispTime').innerText = "Diterima pada: " + data.arrival_time;
            document.getElementById('detPorsi').innerText = data.porsi;
            document.getElementById('detOperator').innerText = data.operator;

            if (data.photo && data.photo !== '-') {
                // Gunakan folder distribusi sesuai backend
                const fullPath = "/static/uploads/distribusi/" + data.photo.replace(/\\/g, '/');
                document.getElementById('imgBukti').src = fullPath;
                document.getElementById('imgZoom').src = fullPath;
            } else {
                document.getElementById('imgBukti').src = "/static/assets/img/theme/no-image.jpg";
            }
        } catch (e) {
            console.error("Error parsing JSON:", e);
        }
    }

    function closeDetail() {
        $('#detailArea').hide(); 
        $('#noDataPlaceholder').show();
    }

    function zoomImage() {
        $('#modalZoom').modal('show');
    }
</script>
{% endblock %}