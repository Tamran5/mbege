{% extends "layouts/base.html" %}

{% block title %} Peta Sebaran Dapur {% endblock %}

{% block stylesheets %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* Kustomisasi Wadah Peta */
    #map-container-card {
        overflow: hidden; 
        box-shadow: 0 15px 35px rgba(50, 50, 93, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07) !important;
    }

    #map-sebaran {
        width: 100%;
        height: 75vh; 
        min-height: 500px;
        z-index: 1;
    }

    /* Kustomisasi Popup Leaflet */
    .leaflet-popup-content-wrapper {
        border-radius: 0.5rem;
        box-shadow: 0 15px 35px rgba(50, 50, 93, 0.2), 0 5px 15px rgba(0, 0, 0, 0.15);
        padding: 0;
        overflow: hidden;
    }
    .leaflet-popup-content {
        margin: 0;
        width: 240px !important;
    }
    
    /* Header Popup */
    .popup-card-header {
        background: linear-gradient(87deg, #5e72e4 0, #825ee4 100%) !important;
        padding: 12px 15px;
    }
    
    /* Body Popup */
    .popup-card-body {
        padding: 15px;
    }
</style>
{% endblock %}


{% block content %}

<div class="header bg-gradient-primary pb-6">
    <div class="container-fluid">
        <div class="header-body">
            <div class="row align-items-center py-4">
                <div class="col-lg-6 col-7">
                    <h6 class="h2 text-white d-inline-block mb-0">
                        <i class="ni ni-map-big mr-2"></i> Peta Sebaran
                    </h6>
                    <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                        <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                            <li class="breadcrumb-item"><a href="#"><i class="fas fa-home"></i></a></li>
                            <li class="breadcrumb-item active" aria-current="page">Wilayah: {{ wilayah if wilayah else 'Semua' }}</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt--6">
    <div class="row">
        
        <div class="col-lg-9">
            <div class="card border-0" id="map-container-card">
                <div class="card-header bg-transparent py-3">
                    <div class="row align-items-center">
                        <div class="col">
                            <h5 class="h3 text-primary mb-0 text-uppercase ls-1">Lokasi Dapur Aktif</h5>
                            <p class="text-sm text-muted mb-0">Menampilkan dapur yang sudah disetujui.</p>
                        </div>
                        <div class="col text-right">
                            <span class="badge badge-pill badge-success">
                                <i class="ni ni-check-bold"></i> Live Data
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="map-sebaran"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-3">
             <div class="card bg-gradient-info border-0">
                <div class="card-body">
                    <div class="row">
                        <div class="col">
                            <h5 class="card-title text-uppercase text-muted mb-0 text-white">Total Dapur</h5>
                            <span class="h2 font-weight-bold mb-0 text-white" id="total-dapur-count">Memuat...</span>
                        </div>
                        <div class="col-auto">
                            <div class="icon icon-shape bg-white text-info rounded-circle shadow">
                                <i class="ni ni-shop"></i>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3 mb-0 text-sm">
                        <span class="text-white mr-2"><i class="fa fa-map-marker-alt"></i></span>
                        <span class="text-nowrap text-white">Wilayah {{ wilayah if wilayah else 'Semua' }}</span>
                    </p>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="h4 mb-0">Mode Peta</h5>
                </div>
                <div class="card-body py-3">
                    <p class="text-sm text-muted">
                        Gunakan tombol layer <img src="https://unpkg.com/leaflet@1.9.4/dist/images/layers.png" width="20"> di pojok kanan atas peta untuk melihat <b>Mode Satelit (Bangunan)</b>.
                    </p>
                    <hr class="my-3">
                    <ul class="list-unstyled mb-0">
                        <li class="py-2">
                            <div class="d-flex align-items-center">
                                <div>
                                    <img src="https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png" style="height: 20px;">
                                </div>
                                <div class="ml-3">
                                    <h6 class="mb-0">Lokasi Dapur</h6>
                                    <p class="text-sm text-muted mb-0">Klik marker untuk detail.</p>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>

        </div> 
    </div> 
    
    {% include "includes/footer.html" %}
</div>

{% endblock %}


{% block javascripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map; 
    
    document.addEventListener("DOMContentLoaded", function() {
        initLeafletMap(); 
    });

    function initLeafletMap() {
        // --- 1. Definisikan Pilihan Layer (Map Styles) ---
        
        // Layer A: Bersih (Jalan)
        var streetMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            attribution: '&copy; OpenStreetMap &copy; CARTO'
        });

        // Layer B: Satelit (Menampilkan Bangunan Asli) - Menggunakan Esri World Imagery
        var satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            maxZoom: 19,
            attribution: 'Tiles &copy; Esri'
        });

        // --- 2. Inisialisasi Peta ---
        map = L.map('map-sebaran', {
            center: [-6.8797, 109.1256], // Default Tegal
            zoom: 13,
            layers: [streetMap], // Default pakai mode jalan (lebih ringan)
            zoomControl: false   // Kita pindah posisinya nanti
        });
        
        // Pindahkan Zoom Control ke pojok kanan bawah
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // --- 3. Tambahkan Kontrol Layer (Tombol Ganti Peta) ---
        var baseMaps = {
            "Peta Jalan (Bersih)": streetMap,
            "Satelit (Bangunan)": satelliteMap
        };
        L.control.layers(baseMaps).addTo(map);

        // --- 4. Muat Data ---
        loadKitchenMarkers();
    }

    function loadKitchenMarkers() {
        fetch('/api/kitchen-locations')
            .then(response => response.json())
            .then(data => {
                
                // Update counter
                const countElement = document.getElementById('total-dapur-count');
                if(countElement) countElement.innerText = data.length;

                if(data.length === 0) {
                     if(countElement) countElement.innerText = "0";
                     return;
                }

                var markers = []; 
                data.forEach(dapur => {
                    var marker = L.marker([dapur.lat, dapur.lng]).addTo(map);
                    markers.push([dapur.lat, dapur.lng]);

                    // Popup Content
                    var popupContent = `
                        <div class="popup-card-header">
                            <h5 class="text-white text-uppercase mb-0" style="font-weight: 700; letter-spacing: 0.5px;">
                                <i class="ni ni-shop mr-1"></i> ${dapur.name}
                            </h5>
                        </div>
                        <div class="popup-card-body">
                            <small class="text-muted text-uppercase font-weight-bold">Pemilik</small>
                            <div class="font-weight-bold text-dark mb-2">${dapur.owner}</div>
                            
                            <small class="text-muted text-uppercase font-weight-bold">Alamat</small>
                            <p class="text-sm text-dark mb-3" style="line-height: 1.3;">${dapur.address}</p>
                            
                            <a href="/data-mitra" class="btn btn-sm btn-block btn-primary shadow-none text-white">
                                Lihat Detail Lengkap
                            </a>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                });

                if (markers.length > 0) {
                    var bounds = new L.LatLngBounds(markers);
                    map.fitBounds(bounds, { padding: [80, 80] });
                }
            })
            .catch(err => console.error("Error loading map:", err));
    }
</script>
{% endblock %}